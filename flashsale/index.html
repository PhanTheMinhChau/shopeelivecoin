<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
  <title>⚡️Flash Sale Shopee</title>
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569;
      --brand:#ee4d2d; --brand-600:#dc2626; --accent:#06b6d4; --ring:#e2e8f0;
      --shadow: 0 4px 20px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:inherit;text-decoration:none}

    .container{max-width:1000px;margin:0 auto;padding:16px 16px 0;}
    header{position:sticky;top:0;z-index:10}

    .toolbar{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:12px 0px}
    .pill{display:flex;gap:8px;align-items:center;background:var(--card);border:1px solid var(--ring);border-radius:999px;padding:10px 12px;box-shadow:var(--shadow)}
    .pill input{border:none;outline:none;background:transparent;width:100%}
    .btn{display:inline-flex;justify-content:center;align-items:center;gap:6px;background:var(--brand);color:#fff;border:none;border-radius:999px;padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:0 8px 24px rgba(238,77,45,.25)}
    .btn:active{transform:translateY(1px)}

    .seg-wrap{padding:0 0 12px}
    .segmented{display:flex;gap:8px;background:var(--card);border:1px solid var(--ring);border-radius:999px;padding:6px;box-shadow:var(--shadow);overflow:auto}
    .seg{flex:1;white-space:nowrap;border:none;background:transparent;padding:8px 14px;border-radius:999px;font-weight:700;color:var(--muted);cursor:pointer}
    .seg.active{background:var(--text);color:#fff}

    /* Countdown (nền mờ) */
/* Countdown (nhỏ, căn giữa, nền mờ) */
.countdown-wrap{
  padding:4px 0 12px;
  display:flex;
  justify-content:center; /* căn giữa */
}

#countdown{
  display:none;
  font-size:13px;
  font-weight:600;
  line-height:1.2;
  padding:2px 6px; /* giảm padding để khít chữ */
  border-radius:999px; /* bo tròn pill */
  color:var(--text);
  background:rgba(255,255,255,0.5); /* nền mờ */
  backdrop-filter:blur(6px) saturate(150%);
  box-shadow:0 1px 4px rgba(0,0,0,0.08);

  display:inline-flex;   /* chỉ dài bằng nội dung */
  align-items:center;
  justify-content:center;
  white-space:nowrap;    /* không xuống dòng */
  width:auto;            /* bỏ chiếm ngang */
  max-width:max-content; /* khít chữ */
}


    /* Promotion horizontal bar */
    .promo-bar{display:flex;overflow-x:auto;gap:8px;padding:10px 16px;max-width:1000px;margin:0 auto}
    .promo-btn{flex:0 0 auto;padding:8px 12px;border-radius:12px;border:1px solid var(--ring);background:var(--card);cursor:pointer;font-weight:700;box-shadow:var(--shadow);color:var(--muted)}
    .promo-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}

    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(4,minmax(0,1fr));}}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .thumb{position:relative;width:100%;padding-top:100%;background:#eef2f7}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .badge{position:absolute;top:8px;left:8px;background:var(--brand);color:#fff;font-size:12px;font-weight:700;border-radius:10px;padding:4px 8px}
    .labels{position:absolute;bottom:8px;left:8px;display:flex;gap:6px;flex-wrap:wrap}
    .label{background:rgba(255,255,255,.9);color:var(--text);border:1px solid var(--ring);font-size:11px;font-weight:700;padding:2px 6px;border-radius:8px}

    .content{padding:10px 12px;display:flex;flex-direction:column;gap:6px}
    .name{font-size:14px;line-height:1.3;height:2.6em;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .price{display:flex;align-items:baseline;gap:8px}
    .price .now{font-size:16px;font-weight:800;color:var(--brand)}
    .price .before{font-size:12px;color:var(--muted);text-decoration:line-through}
    .stock{font-size:12px;color:var(--muted)}

    .loadmore-wrap{position:sticky;bottom:0;z-index:10;padding:16px;background:linear-gradient(0deg,#fff,rgba(255,255,255,.85));backdrop-filter:saturate(140%) blur(6px);border-top:1px solid var(--ring)}
    .loadmore{width:100%;border-radius:999px;background:var(--brand);color:#fff;font-weight:800;border:none;padding:14px 18px;box-shadow:0 8px 24px rgba(239,68,68,.35);cursor:pointer}
    .loadmore:active{transform:translateY(1px)}

    .skeleton{animation:pulse 1.2s ease-in-out infinite;background:linear-gradient(90deg,#f1f5f9,#e2e8f0,#f1f5f9);background-size:200% 100%}
    @keyframes pulse{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .empty{padding:32px;text-align:center;color:var(--muted)}

    /* Loading overlay */
    .loading-overlay{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(8px);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index:9999;
      gap:16px;
    }
    .loading-spinner{
      width:40px;
      height:40px;
      border:3px solid var(--ring);
      border-top:3px solid var(--brand);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }
    .loading-text{
      font-size:16px;
      font-weight:600;
      color:var(--text);
    }

    /* Back to top button */
    .back-to-top{
      position:fixed;
      bottom:20px;
      right:20px;
      width:48px;
      height:48px;
      background:var(--brand);
      color:#fff;
      border:none;
      border-radius:50%;
      box-shadow:0 4px 20px rgba(238,77,45,.3);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      z-index:1000;
      opacity:0;
      visibility:hidden;
      transform:translateY(20px);
      transition:all 0.3s ease;
    }
    .back-to-top.visible{
      opacity:1;
      visibility:visible;
      transform:translateY(0);
    }
    .back-to-top:hover{
      background:var(--brand-600);
      transform:translateY(-2px);
      box-shadow:0 6px 25px rgba(238,77,45,.4);
    }
    .back-to-top:active{
      transform:translateY(0);
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Đang tải dữ liệu...</div>
  </div>

  <center>
    <h2 style="margin: 10px 0;">⚡️ Flash Sale Shopee ⚡️</h2>
  </center>

  <!-- Thanh khung giờ ngang -->
  <div id="promoBar" class="promo-bar"></div>

  <header>
    <div style="background: linear-gradient(180deg,#fff,rgba(255,255,255,.9));">
      <div class="container">
        <div class="toolbar">
          <div class="pill" style="min-width:0">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="10.5" cy="10.5" r="6.5" stroke="currentColor" stroke-width="2"/></svg>
            <input id="kw" placeholder="Nhập từ khóa…" />
          </div>
          <button id="searchBtn" class="btn" title="Tìm kiếm">Tìm</button>
        </div>
        <div class="seg-wrap">
          <div id="sortSeg" class="segmented" role="tablist" aria-label="Sắp xếp">
            <button class="seg" data-sort="price|1">Giá ↑</button>
            <button class="seg" data-sort="price|-1">Giá ↓</button>
            <button class="seg" data-sort="raw_discount|-1">Giảm nhiều</button>
            <button class="seg" data-sort="stock|1">Hiếm</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Đồng hồ đếm ngược (nền mờ) -->
    <div class="countdown-wrap">
      <div id="countdown" role="status" aria-live="polite"></div>
    </div>
  </header>

  <div class="container">
    <div id="grid" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty" style="display:none">Không có sản phẩm phù hợp.</div>
    <div id="sentinel" aria-hidden="true" style="height:1px;"></div>
  </div>

  <div class="loadmore-wrap" style="display: none;">
    <button id="moreBtn" class="loadmore">Xem thêm</button>
  </div>

  <!-- Back to top button -->
  <button id="backToTop" class="back-to-top" title="Lên đầu trang">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <script>
    const PROMO_API='https://sharelink-kappa.vercel.app/promotions';
    const API_BASE='https://sharelink-kappa.vercel.app/flash_sale_test';
    const DEFAULT_QUERY={keyword:'',search_field:'name',sort_field:'price',sort_order:1,items_per_page:16,promotionid:''};

    let state={page_number:1,loading:false,ended:false,params:{...DEFAULT_QUERY},promotions:[]};

    const grid=document.getElementById('grid');
    const emptyEl=document.getElementById('empty');
    const moreBtn=document.getElementById('moreBtn');
    const kwInput=document.getElementById('kw');
    const searchBtn=document.getElementById('searchBtn');
    const promoBar=document.getElementById('promoBar');
    const sortSeg=document.getElementById('sortSeg');
    const countdownEl=document.getElementById('countdown');
    const loadingOverlay=document.getElementById('loadingOverlay');
    const backToTopBtn=document.getElementById('backToTop');

    const toVND=n=>{if(typeof n!=='number')return'';return Math.round(n/100000).toLocaleString('vi-VN',{style:'currency',currency:'VND'})};
    const makeQS=obj=>new URLSearchParams(obj).toString();
    const fmtHour=t=>{const d=new Date(t*1000);return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')};
    const escapeHtml=str=>String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');

    function buildURL(page){const qs=makeQS({...state.params,page_number:page});return `${API_BASE}?${qs}`}

    function skeletonCard(){const d=document.createElement('div');d.className='card';d.innerHTML=`<div class="thumb skeleton"></div><div class="content"><div class="skeleton" style="height:18px;width:90%"></div><div class="skeleton" style="height:14px;width:60%"></div><div class="skeleton" style="height:12px;width:40%"></div></div>`;return d}

    function itemCard(item){
      const {image,shopid,itemid,name,price,price_before_discount,raw_discount,stock}=item;
      const a=document.createElement('a'); a.className='card'; a.href=`https://shopee.vn/product/${shopid}/${itemid}?uls_trackid=53ngrs1m00md&utm_campaign=id_106GHhuqnWi&utm_content=----&utm_medium=affiliates&utm_source=an_17333510032&utm_term=dobjx6gsucq5`; a.target='_blank';
      const imgURL=`https://cf.shopee.vn/file/${image}`;
      a.innerHTML=`<div class="thumb"><img loading="lazy" src="${imgURL}" alt="${escapeHtml(name)}"/>${raw_discount?`<div class='badge'>-${raw_discount}%</div>`:''}<div class='labels'></div></div><div class='content'><div class='name' title='${escapeHtml(name)}'>${escapeHtml(name)}</div><div class='price'><div class='now'>${toVND(price)}</div>${price_before_discount?`<div class='before'>${toVND(price_before_discount)}</div>`:''}</div><div class='stock'>Còn: ${Number.isFinite(stock)?stock:'—'}</div></div>`;
      return a;
    }

    async function fetchPage(page){
      if(state.loading||state.ended) return[];
      state.loading=true; moreBtn.disabled=true; moreBtn.textContent='Đang tải…';
      const skeletons=[...Array(6)].map(skeletonCard); skeletons.forEach(s=>grid.appendChild(s));
      try{
        const url=buildURL(page); const res=await fetch(url);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data=await res.json(); const items=Array.isArray(data)?data:[];
        skeletons.forEach(s=>s.remove());
        const valid=items.filter(x=>typeof x.stock==='number'?x.stock>0:true);
        if(page===1) grid.innerHTML='';
        valid.forEach(i=>grid.appendChild(itemCard(i)));
        emptyEl.style.display=(page===1&&valid.length===0)?'block':'none';
        if(items.length<(state.params.items_per_page||16)){
          state.ended=true; moreBtn.textContent='Hết dữ liệu'; moreBtn.disabled=true;
        }else{ moreBtn.textContent='Xem thêm'; moreBtn.disabled=false; }
        return valid;
      }catch(e){
        console.error(e); skeletons.forEach(s=>s.remove()); emptyEl.style.display='block'; emptyEl.textContent='Lỗi tải dữ liệu'; moreBtn.textContent='Thử lại'; moreBtn.disabled=false; return [];
      }finally{ state.loading=false; }
    }

    function resetAndLoad(){ state.page_number=1; state.ended=false; grid.innerHTML=''; setupInfiniteScroll(); fetchPage(state.page_number); startCountdown(); }

    // ===== Promotion bar =====
    function renderPromotions(){
      promoBar.innerHTML='';
      if(!Array.isArray(state.promotions)||state.promotions.length===0){
        const btn=document.createElement('button'); btn.className='promo-btn'; btn.textContent='—'; btn.disabled=true; promoBar.appendChild(btn); return;
      }
      state.promotions.forEach((p,idx)=>{
        const btn=document.createElement('button'); btn.className='promo-btn'; btn.textContent=fmtHour(p.start_time); btn.dataset.pid=String(p.promotionid);
        if(String(p.promotionid)===String(state.params.promotionid)||(idx===0&&!state.params.promotionid)){
          btn.classList.add('active'); state.params.promotionid=p.promotionid;
        }
        btn.addEventListener('click',()=>{
          document.querySelectorAll('.promo-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          state.params.promotionid=p.promotionid;
          setURLPid(p.promotionid);  // cập nhật URL khi người dùng đổi khung
          resetAndLoad();
        });
        promoBar.appendChild(btn);
      });
    }

    // ===== Auto switch by local time (giữ nguyên hành vi cũ) =====
    function getPidByLocalTime(){
      if(!state.promotions.length) return null;
      const nowSec=Math.floor(Date.now()/1000);
      const cur=state.promotions.find(p=>nowSec>=p.start_time && nowSec<p.end_time);
      if(cur) return cur.promotionid;
      const next=state.promotions.find(p=>nowSec<p.start_time);
      return next? next.promotionid : null;
    }

    function activatePromoButton(pid){
      document.querySelectorAll('.promo-btn').forEach(b=>{
        b.classList.toggle('active', b.dataset.pid===String(pid));
      });
    }

    function checkAutoPromotion(force=false){
      return; // vẫn giữ nguyên như bạn đang để
    }

    let autoTimer; 
    function startAutoWatcher(){
      if(autoTimer) clearInterval(autoTimer);
      autoTimer=setInterval(()=>checkAutoPromotion(false),15000);
      document.addEventListener('visibilitychange',()=>{ if(!document.hidden) checkAutoPromotion(false); });
    }

    // ===== Sort segmented =====
    function applySortUI(val){ const btns=sortSeg.querySelectorAll('.seg'); btns.forEach(b=>{ if(b.dataset.sort===val){ b.classList.add('active'); } else { b.classList.remove('active'); } }); }
    function setSort(val){ const [field,order]=val.split('|'); state.params.sort_field=field; state.params.sort_order=Number(order); applySortUI(val); resetAndLoad(); }
    sortSeg.addEventListener('click',e=>{ const btn=e.target.closest('.seg'); if(!btn) return; const val=btn.dataset.sort; if(!val||btn.classList.contains('active')) return; setSort(val); });
    function initSortDefault(){ applySortUI(`${DEFAULT_QUERY.sort_field}|${DEFAULT_QUERY.sort_order}`); }

    // ===== Infinite scroll =====
    let io; function setupInfiniteScroll(){ if(io){ try{ io.disconnect(); }catch(_){} } io=new IntersectionObserver((entries)=>{ const entry=entries[0]; if(!entry||!entry.isIntersecting) return; if(state.loading||state.ended) return; state.page_number+=1; fetchPage(state.page_number); },{root:null,rootMargin:'800px 0px 0px 0px',threshold:0}); const sent=document.getElementById('sentinel'); if(sent) io.observe(sent); }

    // ===== URL helpers (promotionid) =====
    function getURLPid(){
      const sp = new URLSearchParams(location.search);
      const v = sp.get('promotionid');
      return v ? v.trim() : null;
    }
    function setURLPid(pid, replace=false){
      const sp = new URLSearchParams(location.search);
      if(pid==null || pid===''){
        sp.delete('promotionid');
      }else{
        sp.set('promotionid', String(pid));
      }
      const newUrl = location.pathname + (sp.toString() ? '?' + sp.toString() : '') + location.hash;
      if(replace){ history.replaceState(null, '', newUrl); }
      else{ history.pushState(null, '', newUrl); }
    }
    // Đồng bộ khi người dùng back/forward
    window.addEventListener('popstate', ()=>{
      const pid = getURLPid();
      if(pid && String(state.params.promotionid)!==String(pid)){
        state.params.promotionid = pid;
        activatePromoButton(pid);
        resetAndLoad();
      }
    });

    // ===== Countdown helpers =====
    function getSelectedPromo(){
      const pid = String(state.params.promotionid || '');
      return state.promotions.find(p => String(p.promotionid)===pid) || null;
    }
    function getNextPromoAfter(ts){
      return state.promotions.find(p => p.start_time > ts) || null;
    }
    function formatDHMS(sec){
      if(sec < 0) sec = 0;
      const d = Math.floor(sec/86400);
      const h = Math.floor((sec%86400)/3600);
      const m = Math.floor((sec%3600)/60);
      const s = Math.floor(sec%60);
      const pad = n => String(n).padStart(2,'0');
      return (d>0 ? `${d}d ` : '') + `${pad(h)}:${pad(m)}:${pad(s)}`;
    }
    let countdownTimer = null;
    function updateCountdownOnce(){
      const sel = getSelectedPromo();
      if(!sel){ countdownEl.style.display='none'; return; }
      const now = Math.floor(Date.now()/1000);
      // đang trong khung → ẩn
      if(now >= sel.start_time && now < sel.end_time){
        countdownEl.style.display='none';
        return;
      }
      let target = null, label = '';
      if(now < sel.start_time){
        target = sel.start_time;
        label = 'Bắt đầu sau';
      }else{
        const next = getNextPromoAfter(now);
        if(!next){ countdownEl.style.display='none'; return; }
        target = next.start_time;
        label = 'Khung kế tiếp sau';
      }
      const remain = target - now;
      countdownEl.textContent = `${label}: ${formatDHMS(remain)}`;
      countdownEl.style.display = 'block';
    }
    function startCountdown(){
      if(countdownTimer) clearInterval(countdownTimer);
      updateCountdownOnce();
      countdownTimer = setInterval(updateCountdownOnce, 1000);
    }

    // ===== Bootstrap =====
    async function bootstrap(){
      try{
        const res=await fetch(PROMO_API);
        const promos=await res.json();
        if(Array.isArray(promos)&&promos.length>0){ state.promotions=promos; }
        // render trước
        renderPromotions();

        // Ưu tiên promotionid từ URL (nếu có)
        const urlPid = getURLPid();
        if(urlPid){
          state.params.promotionid = urlPid;
          activatePromoButton(urlPid);
          setURLPid(urlPid, true); // chuẩn hóa URL
        }else{
          // Không có trên URL thì auto chọn theo local time
          const autoPid=getPidByLocalTime();
          if(autoPid){
            state.params.promotionid=autoPid;
            activatePromoButton(autoPid);
            setURLPid(autoPid, true);
          }
        }
      }
      catch(e){ console.error('Lỗi promotions',e); }
      finally{
        // Ẩn loading overlay
        loadingOverlay.style.display='none';
        
        initSortDefault();
        setupInfiniteScroll();
        fetchPage(state.page_number);
        startAutoWatcher();
        checkAutoPromotion(true);
        startCountdown(); // khởi chạy đồng hồ
      }
    }

    // ===== Back to top functionality =====
    function toggleBackToTop(){
      const scrollY = window.scrollY;
      if(scrollY > 300){
        backToTopBtn.classList.add('visible');
      } else {
        backToTopBtn.classList.remove('visible');
      }
    }
    
    function scrollToTop(){
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    // ===== Events =====
    searchBtn.addEventListener('click',()=>{ state.params.keyword=kwInput.value.trim(); resetAndLoad(); });
    kwInput.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); state.params.keyword=kwInput.value.trim(); resetAndLoad(); }});
    moreBtn.addEventListener('click',()=>{ if(state.loading||state.ended) return; state.page_number+=1; fetchPage(state.page_number); });
    backToTopBtn.addEventListener('click', scrollToTop);
    window.addEventListener('scroll', toggleBackToTop);

    bootstrap();
  </script>
</body>
</html>
